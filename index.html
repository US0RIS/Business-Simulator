html'''
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Empire Simulator</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Courier New', monospace; background: var(--bg); color: var(--ui); padding: 20px; line-height: 1.4; transition: all 0.3s; }
        :root { --bg: #000; --ui: #0f0; --hover: #030; --warn: #f00; --success: #0ff; }
        .container { max-width: 1200px; margin: 0 auto; border: 2px solid var(--ui); padding: 20px; background: var(--bg); }
        .settings-btn { position: fixed; top: 20px; right: 20px; background: var(--bg); color: var(--ui); border: 2px solid var(--ui); padding: 10px 15px; cursor: pointer; font-family: inherit; z-index: 999; }
        .settings-btn:hover { background: var(--ui); color: var(--bg); }
        .settings-panel { position: fixed; top: 60px; right: 20px; background: var(--bg); border: 2px solid var(--ui); padding: 20px; z-index: 1000; min-width: 320px; max-height: 80vh; overflow-y: auto; }
        .settings-panel h3 { margin-bottom: 15px; border-bottom: 1px solid var(--ui); padding-bottom: 5px; }
        .color-opt { display: flex; align-items: center; margin: 10px 0; cursor: pointer; padding: 8px; border: 2px solid transparent; }
        .color-opt:hover { border-color: var(--ui); }
        .color-opt input { width: auto; margin-right: 10px; }
        .color-prev { display: inline-block; width: 30px; height: 30px; border: 2px solid var(--ui); margin-left: 10px; }
        .section { margin: 20px 0; padding-bottom: 15px; border-bottom: 1px solid var(--hover); }
        .section:last-of-type { border-bottom: none; }
        .co-selector { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding: 10px; border: 1px solid var(--ui); }
        .co-tab { background: var(--bg); color: var(--ui); border: 2px solid var(--ui); padding: 10px 15px; cursor: pointer; white-space: nowrap; min-width: 150px; text-align: center; }
        .co-tab:hover { background: var(--hover); }
        .co-tab.active { background: var(--ui); color: var(--bg); }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-bottom: 20px; border: 2px solid var(--ui); padding: 10px; }
        .stat-item { padding: 5px; border-bottom: 1px solid var(--hover); }
        .stat-item:last-child { border-bottom: none; }
        .evt-cont { border: 2px solid var(--ui); padding: 20px; margin-bottom: 20px; }
        .evt-cont.pos { border-color: var(--success); }
        .evt-title { font-size: 18px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--ui); }
        .evt-title.pos { color: var(--success); border-bottom-color: var(--success); }
        .evt-desc { margin-bottom: 20px; line-height: 1.6; }
        .choices { display: grid; gap: 10px; }
        .choice-btn { background: var(--bg); color: var(--ui); border: 2px solid var(--ui); padding: 15px; cursor: pointer; font-family: inherit; font-size: 13px; text-align: left; }
        .choice-btn:hover:not(:disabled) { background: var(--ui); color: var(--bg); }
        .choice-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .choice-btn.ignore { border-color: var(--warn); color: var(--warn); }
        .choice-btn.ignore:hover:not(:disabled) { background: var(--warn); color: var(--bg); }
        .actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; margin-bottom: 20px; }
        .act-btn { background: var(--bg); color: var(--ui); border: 2px solid var(--ui); padding: 12px; cursor: pointer; font-family: inherit; font-size: 11px; text-align: center; }
        .act-btn:hover:not(:disabled) { background: var(--ui); color: var(--bg); }
        .act-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        button { background: var(--bg); color: var(--ui); border: 2px solid var(--ui); padding: 12px 20px; cursor: pointer; font-family: inherit; font-size: 14px; }
        button:hover { background: var(--ui); color: var(--bg); }
        .title { text-align: center; font-size: 32px; margin-bottom: 20px; border-bottom: 2px solid var(--ui); padding-bottom: 10px; letter-spacing: 3px; }
        .biz-type, .diff-opt { border: 2px solid var(--ui); padding: 15px; margin: 10px 0; cursor: pointer; }
        .biz-type:hover, .diff-opt:hover { background: var(--hover); }
        .biz-type.sel, .diff-opt.sel { background: var(--ui); color: var(--bg); }
        .hidden { display: none !important; }
        .tab-btns { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 10px; font-size: 12px; background: var(--bg); color: var(--ui); border: 2px solid var(--ui); }
        .tab-btn.active { background: var(--ui); color: var(--bg); }
        .log { background: var(--bg); border: 1px solid var(--ui); padding: 15px; margin-bottom: 15px; max-height: 200px; overflow-y: auto; font-size: 11px; }
        .loan-sect { border: 2px solid var(--ui); padding: 15px; margin-bottom: 20px; }
        .loan-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; }
        .debt-warn { background: var(--bg); border: 2px solid var(--warn); padding: 15px; margin-bottom: 20px; color: var(--warn); }
        .portfolio { border: 2px solid var(--ui); padding: 15px; margin-bottom: 20px; }
        .portfolio h3 { margin-bottom: 10px; border-bottom: 1px solid var(--ui); padding-bottom: 5px; }
        input, select { background: var(--bg); color: var(--ui); border: 2px solid var(--ui); padding: 10px; font-family: inherit; width: 100%; margin: 10px 0; font-size: 14px; }
        input:focus, select:focus { outline: none; border-color: var(--success); }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background: var(--bg); padding: 30px; border: 3px solid var(--ui); max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-title { font-size: 20px; margin-bottom: 15px; border-bottom: 1px solid var(--ui); padding-bottom: 10px; }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btns button { flex: 1; }
        .box { border: 2px solid var(--ui); padding: 20px; margin-bottom: 20px; }
        pre { font-family: inherit; white-space: pre-wrap; line-height: 1.6; }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 5px; }
        .loan-inline { border: 2px solid var(--success); padding: 15px; margin: 15px 0; background: var(--hover); }
        .loan-inline h4 { color: var(--success); margin-bottom: 10px; }
        .milestone { border: 2px solid var(--success); padding: 15px; margin-bottom: 20px; background: var(--hover); }
        .milestone h3 { color: var(--success); margin-bottom: 10px; }
        @media (max-width: 768px) {
            .actions { grid-template-columns: 1fr; }
            .stats { grid-template-columns: 1fr 1fr; }
            .loan-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <button class="settings-btn" onclick="toggleSettings()">SETTINGS</button>
    
    <div id="settingsPanel" class="settings-panel hidden">
        <h3>SETTINGS</h3>
        <div class="section">
            <label style="display: block; margin: 15px 0;">
                Game Speed:
                <select id="speedSelect" onchange="onSpeedChange()">
                    <option value="slow">Slow</option>
                    <option value="normal" selected>Normal</option>
                    <option value="fast">Fast</option>
                </select>
            </label>
        </div>
        <div class="section">
            <strong style="display: block; margin-bottom: 10px;">Color Presets:</strong>
            <div id="colorPresets"></div>
        </div>
        <div class="section">
            <button onclick="saveGame()" style="width: 100%; margin-bottom: 10px;">SAVE GAME</button>
            <button onclick="loadGame()" style="width: 100%; margin-bottom: 10px;">LOAD GAME</button>
            <button onclick="restartGame()" style="width: 100%; margin-bottom: 10px; border-color: var(--warn); color: var(--warn);">RESTART GAME</button>
            <button onclick="toggleSettings()" style="width: 100%;">CLOSE</button>
        </div>
    </div>

    <div id="transferModal" class="modal hidden" onclick="if(event.target.id==='transferModal')this.classList.add('hidden')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title">TRANSFER FUNDS</div>
            <p style="margin-bottom: 15px;">Move money between companies</p>
            <label>FROM: <span id="fromCo"></span><br>Available: $<span id="availCash">0</span></label>
            <label>TO:<br><select id="targetCo"></select></label>
            <label>AMOUNT:<br><input type="number" id="transferAmt" placeholder="Enter amount" min="0"></label>
            <div class="modal-btns">
                <button onclick="confirmTransfer()">TRANSFER</button>
                <button onclick="closeModal('transferModal')">CANCEL</button>
            </div>
        </div>
    </div>

    <div id="productModal" class="modal hidden" onclick="if(event.target.id==='productModal')this.classList.add('hidden')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title">NEW PRODUCT DEVELOPMENT</div>
            <div class="form-group">
                <label>Product Name:</label>
                <input type="text" id="prodName" placeholder="Enter product name">
            </div>
            <div class="form-group">
                <label>Product Type:</label>
                <select id="prodType">
                    <option value="">-- Select Type --</option>
                    <option value="premium">Premium (High price, high quality)</option>
                    <option value="standard">Standard (Balanced price/quality)</option>
                    <option value="budget">Budget (Low price, high volume sales)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Marketing Strategy:</label>
                <select id="prodMktg">
                    <option value="">-- Select Strategy --</option>
                    <option value="aggressive">Aggressive (+$5000 cost, max reach)</option>
                    <option value="moderate">Moderate (+$2500 cost, good reach)</option>
                    <option value="minimal">Minimal (+$500 cost, minimal growth)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Target Market:</label>
                <select id="prodTarget">
                    <option value="">-- Select Market --</option>
                    <option value="youth">Youth (18-25)</option>
                    <option value="professional">Professionals (25-45)</option>
                    <option value="senior">Seniors (45+)</option>
                    <option value="all">Mass Market (All ages)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Development Budget:</label>
                <select id="prodBudget">
                    <option value="">-- Select Budget --</option>
                    <option value="low">Low ($5,000)</option>
                    <option value="medium">Medium ($10,000)</option>
                    <option value="high">High ($20,000)</option>
                </select>
            </div>
            <div style="border: 1px solid var(--ui); padding: 10px; margin: 15px 0;">
                <strong>TOTAL COST: $<span id="prodCost">0</span></strong><br>
                <span id="prodEst" style="font-size: 12px;"></span>
            </div>
            <div id="prodLoans" class="loan-inline hidden">
                <h4>NEED FUNDS? TAKE A LOAN:</h4>
                <button class="act-btn" onclick="quickLoanModal(5000,250,36)" style="width: 100%; margin: 5px 0;">Micro: +$5K (-$250/mo x36)</button>
                <button class="act-btn" onclick="quickLoanModal(10000,500,36)" style="width: 100%; margin: 5px 0;">Small: +$10K (-$500/mo x36)</button>
                <button class="act-btn" onclick="quickLoanModal(30000,1500,36)" style="width: 100%; margin: 5px 0;">Business: +$30K (-$1500/mo x36)</button>
            </div>
            <div class="modal-btns">
                <button onclick="confirmProduct()">LAUNCH PRODUCT</button>
                <button onclick="closeModal('productModal')">CANCEL</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="title">BUSINESS EMPIRE SIMULATOR</div>
        
        <div id="diffScreen">
            <h2 style="margin-bottom: 20px;">SELECT DIFFICULTY</h2>
            <div class="diff-opt" onclick="selectDiff('easy')">
                <strong>EASY MODE</strong><br>
                Start with some revenue and customers<br>
                Forgiving market conditions<br>
                Slower stat decay<br>
                Good for learning the game
            </div>
            <div class="diff-opt" onclick="selectDiff('hard')">
                <strong>REALISTIC MODE (Harder)</strong><br>
                Start with $20,000 but ZERO revenue<br>
                Must build customer base from scratch<br>
                Realistic business challenges<br>
                Faster stat decay and tougher events<br>
                True to real business difficulty
            </div>
        </div>

        <div id="setupScreen" class="hidden">
            <h2 style="margin-bottom: 20px;">CREATE YOUR BUSINESS</h2>
            <input type="text" id="playerName" placeholder="Your player name" value="">
            <input type="text" id="coName" placeholder="Your company's name" value="">
            <h3 style="margin: 30px 0 15px 0; border-bottom: 1px solid var(--ui); padding-bottom: 5px;">CHOOSE BUSINESS TYPE</h3>
            <div id="bizTypes"></div>
            <button onclick="startGame()" style="width: 100%; padding: 15px; margin-top: 20px;">START GAME</button>
        </div>

        <div id="gameScreen" class="hidden">
            <div id="milestoneBox" class="milestone hidden">
                <h3>üèÜ MILESTONE ACHIEVED!</h3>
                <div id="milestoneContent"></div>
            </div>
            <div id="portfolio" class="portfolio hidden">
                <h3>PORTFOLIO OVERVIEW</h3>
                <pre id="portContent"></pre>
            </div>
            <div id="debtWarn" class="debt-warn hidden"></div>
            <div id="coSelector" class="co-selector"></div>
            <div class="stats" id="stats"></div>

            <div id="reportScreen" class="hidden">
                <div class="box">
                    <h3>MONTHLY REPORT - MONTH <span id="reportMonth"></span></h3>
                    <pre id="reportContent"></pre>
                </div>
                <button onclick="showEvent()" style="width: 100%; padding: 15px;">CONTINUE</button>
            </div>

            <div id="eventScreen" class="hidden">
                <div id="evtCont" class="evt-cont">
                    <div id="evtTitle" class="evt-title"></div>
                    <div class="evt-desc" id="evtDesc"></div>
                    <div id="evtLoans" class="loan-inline hidden">
                        <h4>NEED FUNDS FOR THESE OPTIONS? TAKE A LOAN:</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
                            <button class="act-btn" onclick="quickLoanEvt(5000,250,36)">Micro: +$5K<br>-$250/mo x36</button>
                            <button class="act-btn" onclick="quickLoanEvt(10000,500,36)">Small: +$10K<br>-$500/mo x36</button>
                            <button class="act-btn" onclick="quickLoanEvt(30000,1500,36)">Business: +$30K<br>-$1500/mo x36</button>
                        </div>
                    </div>
                    <div class="choices" id="choices"></div>
                </div>
            </div>

            <div id="actionScreen" class="hidden">
                <div class="box" id="result"></div>
                <div class="loan-sect">
                    <h3>FINANCING (DEBT: <span id="debtPct">0</span>%)</h3>
                    <div class="loan-grid">
                        <button class="act-btn" onclick="quickLoan(5000,250,36)">MICRO LOAN<br>+$5,000<br>-$250/mo x36<br>Max: 20% debt</button>
                        <button class="act-btn" onclick="quickLoan(10000,500,36)">SMALL LOAN<br>+$10,000<br>-$500/mo x36<br>Max: 30% debt</button>
                        <button class="act-btn" onclick="quickLoan(30000,1500,36)">BUSINESS LOAN<br>+$30,000<br>-$1,500/mo x36<br>Max: 50% | Rep: 50+</button>
                        <button class="act-btn" onclick="quickLoan(75000,3500,36)">CREDIT LINE<br>+$75,000<br>-$3,500/mo x36<br>Max: 65% | Rep: 70+</button>
                    </div>
                </div>
                <div class="log">
                    <strong>ACTION LOG:</strong>
                    <div id="logContent" style="margin-top: 5px;">No actions taken this month.</div>
                </div>
                <div class="tab-btns" id="tabs"></div>
                <div id="opsTab" class="actions"></div>
                <div id="growthTab" class="actions hidden"></div>
                <div id="financeTab" class="actions hidden"></div>
                <div id="marketingTab" class="actions hidden"></div>
                <div id="empireTab" class="actions hidden"></div>
                <button onclick="nextMonth()" style="width: 100%; padding: 15px; margin-top: 15px;">CONTINUE TO NEXT MONTH</button>
            </div>

            <div id="victoryScreen" class="hidden">
                <div class="box" style="text-align: center;">
                    <h2 style="margin-bottom: 20px;">VICTORY!</h2>
                    <pre id="victoryContent"></pre>
                </div>
                <button onclick="continueVictory()" style="width: 100%; padding: 15px; margin-bottom: 10px;">CONTINUE</button>
                <button onclick="resetGame()" style="width: 100%; padding: 15px;">NEW GAME</button>
            </div>

            <div id="gameOverScreen" class="hidden">
                <div class="box" style="text-align: center;">
                    <h2 style="margin-bottom: 20px; color: var(--warn);">BANKRUPTCY</h2>
                    <pre id="gameOverContent"></pre>
                </div>
                <button onclick="closeCo()" style="width: 100%; padding: 15px; margin-bottom: 10px;">CLOSE COMPANY</button>
                <button onclick="resetGame()" style="width: 100%; padding: 15px;">NEW GAME</button>
            </div>
        </div>
    </div>

    <script>
        let selBiz=null,selDiff=null,curTab='ops',actions=[],cos=[],actIdx=0,nextId=1,speed={slow:1.5,normal:1,fast:0.7},isHard=false,curEvt=null;
        const colors=[
            {name:'Classic (Green on Black)',bg:'#000',ui:'#0f0'},
            {name:'Cyan on Black',bg:'#000',ui:'#0ff'},
            {name:'Magenta on Black',bg:'#000',ui:'#f0f'},
            {name:'Yellow on Black',bg:'#000',ui:'#ff0'},
            {name:'Orange on Black',bg:'#000',ui:'#f80'},
            {name:'Green on Dark Blue',bg:'#1a1a2e',ui:'#0f0'},
            {name:'Black on White',bg:'#fff',ui:'#000'},
            {name:'White on Dark Gray',bg:'#2b2b2b',ui:'#fff'},
            {name:'Blue on Dark',bg:'#1e1e1e',ui:'#0df'},
            {name:'GitHub Dark',bg:'#0d1117',ui:'#58a6ff'}
        ];
        const bizTypes={
            easy:{
                tech:{name:'Tech Startup',cash:8000,emp:0,qual:40,cust:30,rep:35,rev:2800,baseExp:800,desc:'High growth, volatile market, innovation focused'},
                retail:{name:'Retail Store',cash:10000,emp:0,qual:50,cust:80,rep:45,rev:4000,baseExp:1200,desc:'Steady income, inventory management, foot traffic'},
                restaurant:{name:'Restaurant',cash:7000,emp:0,qual:45,cust:60,rep:40,rev:4500,baseExp:1500,desc:'High volume, quality critical, food trends'},
                consulting:{name:'Consulting Firm',cash:12000,emp:0,qual:60,cust:20,rep:55,rev:5500,baseExp:800,desc:'Reputation dependent, high margins, expertise'},
                ecommerce:{name:'E-Commerce',cash:9000,emp:0,qual:45,cust:50,rep:38,rev:3200,baseExp:900,desc:'Online sales, scalable, logistics critical'},
                airline:{name:'Regional Airline',cash:15000,emp:0,qual:35,cust:40,rep:30,rev:6000,baseExp:2500,desc:'High costs, safety critical, seasonal demand'},
                hotel:{name:'Boutique Hotel',cash:11000,emp:0,qual:55,cust:35,rep:50,rev:4800,baseExp:1800,desc:'Service quality, location dependent, hospitality'},
                manufacturing:{name:'Manufacturing',cash:13000,emp:0,qual:50,cust:25,rep:40,rev:5200,baseExp:2000,desc:'Production efficiency, supply chain, B2B sales'}
            },
            hard:{
                tech:{name:'Tech Startup',cash:20000,emp:0,qual:20,cust:0,rep:10,rev:0,baseExp:500,desc:'High growth, volatile market, innovation focused'},
                retail:{name:'Retail Store',cash:20000,emp:0,qual:30,cust:0,rep:15,rev:0,baseExp:600,desc:'Steady income, inventory management, foot traffic'},
                restaurant:{name:'Restaurant',cash:20000,emp:0,qual:25,cust:0,rep:10,rev:0,baseExp:700,desc:'High volume, quality critical, food trends'},
                consulting:{name:'Consulting Firm',cash:20000,emp:0,qual:35,cust:0,rep:20,rev:0,baseExp:400,desc:'Reputation dependent, high margins, expertise'},
                ecommerce:{name:'E-Commerce',cash:20000,emp:0,qual:25,cust:0,rep:12,rev:0,baseExp:500,desc:'Online sales, scalable, logistics critical'},
                airline:{name:'Regional Airline',cash:20000,emp:0,qual:15,cust:0,rep:8,rev:0,baseExp:1200,desc:'High costs, safety critical, seasonal demand'},
                hotel:{name:'Boutique Hotel',cash:20000,emp:0,qual:30,cust:0,rep:18,rev:0,baseExp:800,desc:'Service quality, location dependent, hospitality'},
                manufacturing:{name:'Manufacturing',cash:20000,emp:0,qual:25,cust:0,rep:15,rev:0,baseExp:900,desc:'Production efficiency, supply chain, B2B sales'}
            }
        };
        const acts={
            ops:[
                {id:'hire',label:'Hire Employee',cost:2500},
                {id:'fire',label:'Fire Employee',cost:800},
                {id:'train',label:'Train Staff',cost:1500},
                {id:'wages',label:'Raise Wages',cost:'varies'},
                {id:'workplace',label:'Improve Workplace',cost:3000},
                {id:'automate',label:'Automate',cost:5000},
                {id:'quality',label:'Quality Control',cost:2000},
                {id:'cs',label:'Customer Service',cost:1800},
                {id:'maintain',label:'Maintenance',cost:1000}
            ],
            growth:[
                {id:'expand',label:'New Location',cost:15000},
                {id:'product',label:'New Product',cost:'custom'},
                {id:'partner',label:'Partnership',cost:4000},
                {id:'franchise',label:'Franchise',cost:12000},
                {id:'acquire',label:'Acquire Competitor',cost:25000},
                {id:'intl',label:'Go International',cost:35000}
            ],
            finance:[
                {id:'investor',label:'Seek Investor',cost:'equity'},
                {id:'cut',label:'Cut Costs',cost:'harsh'},
                {id:'stocks',label:'Invest Stocks',cost:5000},
                {id:'realestate',label:'Real Estate',cost:18000},
                {id:'refinance',label:'Refinance',cost:3000},
                {id:'payoff',label:'Pay Off Loan',cost:'varies'}
            ],
            marketing:[
                {id:'marketing',label:'Campaign',cost:3500},
                {id:'social',label:'Social Media',cost:1200},
                {id:'pr',label:'PR Campaign',cost:2500},
                {id:'rebrand',label:'Rebrand',cost:5000},
                {id:'influencer',label:'Influencer',cost:4000},
                {id:'seo',label:'SEO',cost:3000}
            ],
            empire:[
                {id:'newco',label:'Start Company',cost:20000},
                {id:'transfer',label:'Transfer Funds',cost:'free'},
                {id:'cross',label:'Cross-Promote',cost:2000},
                {id:'merge',label:'Merge',cost:'free'},
                {id:'sell',label:'Sell Company',cost:'free'}
            ]
        };
        const evts={
            universal:[
                {title:"Unexpected Windfall",desc:"A client overpaid and told you to keep the difference as a bonus.",positive:true,requires:{cust:10},ignoreEffect:{},choices:[{text:"Accept graciously (Free +$5000)",cost:0,effects:{cash:5000,rep:5}},{text:"Invest in growth (-$2000 + windfall, +40 cust)",cost:-3000,effects:{cust:40}}]},
                {title:"Media Feature",desc:"Local news wants to feature your business in a positive story.",positive:true,requires:{rep:60},ignoreEffect:{},choices:[{text:"Accept (Free +50 cust, +15 rep)",cost:0,effects:{cust:50,rep:15}},{text:"Decline politely",cost:0,effects:{}}]},
                {title:"Talented Applicant",desc:"An overqualified candidate wants to work for you at standard pay.",positive:true,requires:{},ignoreEffect:{},choices:[{text:"Hire immediately (-$2500, +1 emp, +20 qual, +$600/mo)",cost:2500,effects:{emp:1,qual:20,expAdd:600}},{text:"Pass on opportunity",cost:0,effects:{}}]},
                {title:"Government Grant",desc:"You qualify for a small business development grant.",positive:true,requires:{emp:1},ignoreEffect:{},choices:[{text:"Apply (Free +$8000)",cost:0,effects:{cash:8000}},{text:"Decline",cost:0,effects:{}}]},
                {title:"Loyal Customer Referrals",desc:"Your best customers are actively referring new business.",positive:true,requires:{cust:10,qual:60},ignoreEffect:{},choices:[{text:"Launch referral program (-$2000, +60 cust)",cost:2000,effects:{cust:60,rep:10}},{text:"Just thank them (Free +30 cust)",cost:0,effects:{cust:30}}]},
                {title:"Talent Poaching",desc:"Star employee received competitor offer - 60% higher salary.",requires:{emp:2},ignoreEffect:{qual:-15,morale:-8,emp:-1,expAdd:-600},choices:[{text:"Match offer (+$1800/mo, Morale +10)",cost:0,effects:{expAdd:1800,morale:10}},{text:"Counter with equity (+$900/mo)",cost:0,effects:{expAdd:900,morale:15}},{text:"Let go, hire replacement (-$3500, Qual -15)",cost:3500,effects:{qual:-15,morale:-8}}]},
                {title:"Cash Flow Crisis",desc:"Major client payment delayed 60 days. You need to make payroll now.",requires:{emp:2,rev:1000},ignoreEffect:{cash:-5000,rep:-20,morale:-30},choices:[{text:"Take emergency loan (-$3000 fees, +$10K)",cost:-7000,effects:{loans:{monthly:500,months:24}}},{text:"Delay vendor payments (Rep -15)",cost:0,effects:{rep:-15}}]}
            ],
            tech:[
                {title:"Product Launch Opportunity",desc:"Major tech conference wants you to demo your product. High visibility but risky if product isn't ready.",positive:true,requires:{qual:50},ignoreEffect:{},choices:[{text:"Accept & polish product (-$8000, +80 cust, +25 rep)",cost:8000,effects:{cust:80,rep:25,qual:10}},{text:"Decline and focus internally",cost:0,effects:{}}]},
                {title:"Server Outage",desc:"Critical infrastructure failure causing service downtime. Customers are complaining on social media.",requires:{cust:20},ignoreEffect:{cust:-40,rep:-25},choices:[{text:"Emergency fix + compensation (-$6000, Rep +5)",cost:6000,effects:{rep:5,cust:-10}},{text:"Upgrade infrastructure (-$15000, Qual +30)",cost:15000,effects:{qual:30,expAdd:300}}]}
            ],
            retail:[
                {title:"Seasonal Inventory Opportunity",desc:"Supplier offering 40% discount on holiday inventory. Could be huge profits or dead stock.",positive:true,requires:{cash:5000},ignoreEffect:{},choices:[{text:"Buy large stock (-$10000, potential +$18K revenue)",cost:10000,effects:{revBoost:3000}},{text:"Conservative order (-$4000, +$6K revenue)",cost:4000,effects:{revBoost:1000}},{text:"Skip this season",cost:0,effects:{}}]},
                {title:"Shoplifting Ring",desc:"Security footage reveals organized theft operation targeting your store. Monthly losses mounting.",requires:{cust:30},ignoreEffect:{cash:-3000,qual:-10},choices:[{text:"Hire security (-$2500, +$400/mo)",cost:2500,effects:{expAdd:400}},{text:"Install cameras only (-$1500)",cost:1500,effects:{}}]}
            ],
            restaurant:[
                {title:"Celebrity Diner",desc:"Local celebrity loves your food and wants to partner on signature dish for their Instagram followers.",positive:true,requires:{qual:60},ignoreEffect:{},choices:[{text:"Create signature dish (-$3500, +100 cust)",cost:3500,effects:{cust:100,rep:20}},{text:"Thank them but decline",cost:0,effects:{cust:20}}]},
                {title:"Health Inspection Issues",desc:"Surprise health inspection found minor violations. Need to address before next check or face closure.",requires:{cust:15},ignoreEffect:{rep:-30,cust:-50},choices:[{text:"Immediate fixes (-$4000, Qual +15)",cost:4000,effects:{qual:15,rep:5}},{text:"Complete overhaul (-$9000, Qual +35, Rep +15)",cost:9000,effects:{qual:35,rep:15}}]}
            ],
            consulting:[
                {title:"Industry Award Nomination",desc:"Your firm has been nominated for 'Consultancy of the Year'. Winning would be massive for reputation.",positive:true,requires:{rep:70},ignoreEffect:{},choices:[{text:"Campaign for award (-$5000, 50% chance +40 rep)",cost:5000,effects:{rep:Math.random()>0.5?40:10,cust:30}},{text:"Just attend ceremony (Free +10 rep)",cost:0,effects:{rep:10}}]},
                {title:"Client Data Breach",desc:"Potential security incident involving client confidential data. Need to investigate and respond quickly.",requires:{cust:10},ignoreEffect:{rep:-40,cust:-30},choices:[{text:"Full audit + legal (-$12000, Rep -10)",cost:12000,effects:{rep:-10,cust:-5}},{text:"Minimal response (-$3000, Rep -20)",cost:3000,effects:{rep:-20,cust:-15}}]}
            ],
            ecommerce:[
                {title:"Viral Product Moment",desc:"One of your products went viral on TikTok. Orders surging but need to scale fulfillment fast.",positive:true,requires:{cust:25},ignoreEffect:{qual:-20},choices:[{text:"Scale up fulfillment (-$12000, +150 cust, +$2K/mo)",cost:12000,effects:{cust:150,rev:2000,expAdd:1500}},{text:"Maintain current capacity (+50 cust)",cost:0,effects:{cust:50}}]},
                {title:"Shipping Delays",desc:"Supply chain issues causing 2-3 week delays. Customers demanding refunds and leaving bad reviews.",requires:{cust:30},ignoreEffect:{cust:-60,rep:-25},choices:[{text:"Expedited shipping (-$8000, save reputation)",cost:8000,effects:{rep:5,cust:-15}},{text:"Switch carriers (-$5000, +$600/mo)",cost:5000,effects:{expAdd:600,cust:-20}}]}
            ],
            airline:[
                {title:"New Route Opportunity",desc:"Popular tourist destination has slot availability. High demand route but requires new plane.",positive:true,requires:{rep:40},ignoreEffect:{},choices:[{text:"Lease plane & launch (-$25000, +$4K/mo, +100 cust)",cost:25000,effects:{rev:4000,cust:100,expAdd:3000}},{text:"Partnership instead (-$8000, +$1.5K/mo)",cost:8000,effects:{rev:1500,expAdd:500}}]},
                {title:"Safety Incident",desc:"Minor mechanical issue forced emergency landing. No injuries but FAA investigating. Media coverage negative.",requires:{cust:20},ignoreEffect:{rep:-35,cust:-80},choices:[{text:"Full fleet inspection (-$18000, Qual +25)",cost:18000,effects:{qual:25,rep:-10,cust:-20}},{text:"Address specific issue (-$8000, Rep -15)",cost:8000,effects:{rep:-15,cust:-30}}]}
            ],
            hotel:[
                {title:"Five-Star Review Opportunity",desc:"Travel blogger with 500K followers wants complimentary stay for review. Could be game-changing exposure.",positive:true,requires:{qual:65},ignoreEffect:{},choices:[{text:"Premium experience (-$2000, +80 cust, +20 rep)",cost:2000,effects:{cust:80,rep:20}},{text:"Standard stay (-$500, +40 cust)",cost:500,effects:{cust:40,rep:8}}]},
                {title:"Bed Bug Report",desc:"Guest claimed bed bugs in room. Even if false, social media post is spreading. Need damage control.",requires:{cust:20},ignoreEffect:{rep:-30,cust:-70},choices:[{text:"Full fumigation + PR (-$10000, Qual +20)",cost:10000,effects:{qual:20,rep:-5,cust:-15}},{text:"Room-by-room check (-$4000, Rep -15)",cost:4000,effects:{rep:-15,cust:-30}}]}
            ],
            manufacturing:[
                {title:"Automation Upgrade Available",desc:"New robotics system could cut production costs by 40% but requires significant upfront investment.",positive:true,requires:{cash:20000},ignoreEffect:{},choices:[{text:"Full automation (-$30000, -$1200/mo costs)",cost:30000,effects:{expAdd:-1200,qual:15}},{text:"Partial upgrade (-$12000, -$400/mo)",cost:12000,effects:{expAdd:-400,qual:5}}]},
                {title:"Supply Chain Disruption",desc:"Key supplier went bankrupt. Need alternative source immediately or halt production for weeks.",requires:{cust:15},ignoreEffect:{rev:-3000,cust:-40},choices:[{text:"Premium supplier (-$8000, +$800/mo)",cost:8000,effects:{expAdd:800,qual:10}},{text:"Cheaper alternative (-$3000, Qual -10)",cost:3000,effects:{qual:-10}}]}
            ]
        };
        const milestones=[
            {cash:50000,name:"50K Milestone",bonus:{cash:5000},msg:"Reached $50K! Bonus: +$5K"},
            {cash:100000,name:"100K Milestone",bonus:{cash:10000,rep:10},msg:"Reached $100K! Bonus: +$10K, +10 Rep"},
            {cash:250000,name:"250K Milestone",bonus:{cash:25000,rep:15},msg:"Reached $250K! Bonus: +$25K, +15 Rep"},
            {cust:200,name:"200 Customers",bonus:{rev:1000},msg:"200 Customers! Bonus: +$1K/mo revenue"},
            {cust:500,name:"500 Customers",bonus:{rev:2000,rep:10},msg:"500 Customers! Bonus: +$2K/mo, +10 Rep"},
            {emp:10,name:"10 Employees",bonus:{qual:10,morale:15},msg:"10 Employees! Bonus: +10 Quality, +15 Morale"},
            {rep:90,name:"Elite Reputation",bonus:{cust:100,rev:1500},msg:"Elite Reputation! Bonus: +100 Customers, +$1.5K/mo"}
        ];

        document.addEventListener('DOMContentLoaded',()=>{
            renderColors();
            renderBizTypes();
            renderTabs();
            ['prodType','prodMktg','prodTarget','prodBudget'].forEach(id=>{
                const el=document.getElementById(id);
                if(el)el.addEventListener('change',updateProdCost);
            });
            cos.forEach(migrate);
        });

        function renderColors(){
            document.getElementById('colorPresets').innerHTML=colors.map((p,i)=>
                `<div class="color-opt" onclick="changeColors('${p.bg}','${p.ui}')">
                    <input type="radio" name="colorScheme" ${i===0?'checked':''}>
                    <span>${p.name}</span>
                    <span class="color-prev" style="background:${p.ui}"></span>
                </div>`
            ).join('');
        }

        function renderBizTypes(){
            const mode=isHard?'hard':'easy';
            document.getElementById('bizTypes').innerHTML=Object.keys(bizTypes[mode]).map(type=>{
                const s=bizTypes[mode][type];
                return `<div class="biz-type" onclick="selectBiz('${type}')">
                    <strong>${s.name.toUpperCase()}</strong><br>
                    ${s.desc}<br>
                    <span>Start: $${(s.cash/1000).toFixed(0)}K | Quality: ${s.qual}${isHard?' | NO REVENUE':''}</span>
                </div>`;
            }).join('');
        }

        function renderTabs(){
            document.getElementById('tabs').innerHTML=['ops','growth','finance','marketing','empire']
                .map(t=>`<button class="tab-btn ${t==='ops'?'active':''}" onclick="showTab('${t}')">${t.toUpperCase()}</button>`)
                .join('');
        }

        function changeColors(bg,ui){
            const r=document.documentElement;
            r.style.setProperty('--bg',bg);
            r.style.setProperty('--ui',ui);
            r.style.setProperty('--hover',bg==='#000'||bg==='#000000'?ui.replace(/[0-9a-f]{2}/gi,m=>('0'+Math.floor(parseInt(m,16)*0.2).toString(16)).slice(-2)):bg==='#ffffff'||bg==='#fff'?'#f0f0f0':bg.replace(/[0-9a-f]{2}/gi,m=>('0'+Math.min(255,Math.floor(parseInt(m,16)*1.3)).toString(16)).slice(-2)));
        }

        function toggleSettings(){document.getElementById('settingsPanel').classList.toggle('hidden');}
        function onSpeedChange(){}
        
        function saveGame(){
            try{
                localStorage.setItem('bizEmpire',JSON.stringify({cos,actIdx,nextId,isHard,selBiz,selDiff,curTab,actions}));
                alert('Game saved!');
            }catch(e){alert('Save failed');}
        }

        function loadGame(){
            try{
                const d=JSON.parse(localStorage.getItem('bizEmpire'));
                if(!d)return alert('No save found');
                cos=d.cos||[];actIdx=d.actIdx||0;nextId=d.nextId||1;isHard=d.isHard||false;
                selBiz=d.selBiz;selDiff=d.selDiff;curTab=d.curTab||'ops';actions=d.actions||[];
                cos.forEach(migrate);
                if(cos.length>0){
                    hide('diffScreen');hide('setupScreen');show('gameScreen');
                    updateSelector();renderActions();updateDisplay();showReport();
                }
                alert('Loaded!');
                toggleSettings();
            }catch(e){alert('Load failed');}
        }

        function restartGame(){
            if(confirm('Restart? All progress lost.')){
                localStorage.removeItem('bizEmpire');
                resetGame();
                toggleSettings();
            }
        }

        function selectDiff(d){
            document.querySelectorAll('.diff-opt').forEach(el=>el.classList.remove('sel'));
            event.target.closest('.diff-opt').classList.add('sel');
            selDiff=d;
            isHard=(d==='hard');
            renderBizTypes();
            hide('diffScreen');
            show('setupScreen');
        }

        function selectBiz(t){
            document.querySelectorAll('.biz-type').forEach(el=>el.classList.remove('sel'));
            event.target.closest('.biz-type').classList.add('sel');
            selBiz=t;
        }

        function createCo(type,name,first=false){
            const mode=isHard?'hard':'easy';
            const t=bizTypes[mode][type];
            return {
                id:nextId++,name,type,cash:first?t.cash:0,month:1,emp:t.emp,rep:t.rep,
                cust:t.cust,qual:t.qual,morale:60,rev:t.rev,
                baseExp:t.baseExp,expAdd:0,revBoost:0,
                loans:[],total:{rev:0,exp:0},victory:false,eventHistory:[],milestones:[]
            };
        }

        function getSpeed(){return speed[document.getElementById('speedSelect').value];}

        function startGame(){
            const name=document.getElementById('coName').value.trim()||'TechCorp';
            if(!selBiz||!selDiff)return alert('Select difficulty and type');
            cos=[createCo(selBiz,name,true)];
            actIdx=0;
            hide('setupScreen');
            show('gameScreen');
            updateSelector();
            renderActions();
            updateDisplay();
            showReport();
        }

        function renderActions(){
            Object.keys(acts).forEach(tab=>{
                const cont=document.getElementById(tab+'Tab');
                cont.innerHTML=acts[tab].map(a=>{
                    let cost=a.cost==='custom'?'CUSTOM':typeof a.cost==='number'?`-$${a.cost.toLocaleString()}`:a.cost;
                    return `<button class="act-btn" onclick="act('${a.id}')">${a.label}<br>${cost}</button>`;
                }).join('');
            });
        }

        function updateSelector(){
            document.getElementById('coSelector').innerHTML=cos.map((co,i)=>{
                migrate(co);
                const net=calcRev(co)-calcExp(co);
                return `<div class="co-tab ${i===actIdx?'active':''}" onclick="switchCo(${i})">${co.name}<br>$${co.cash.toLocaleString()}<br>${net>=0?'+':''}$${net.toLocaleString()}/mo</div>`;
            }).join('')+`<div class="co-tab" style="border-style:dashed" onclick="act('newco')">+ NEW<br>COMPANY</div>`;
            updatePort();
        }

        function updatePort(){
            if(cos.length>1){
                const cash=cos.reduce((s,c)=>s+c.cash,0);
                const rev=cos.reduce((s,c)=>s+calcRev(c),0);
                const emp=cos.reduce((s,c)=>s+c.emp,0);
                document.getElementById('portContent').textContent=
                    `Companies: ${cos.length}\nTotal Cash: $${cash.toLocaleString()}\nCombined Revenue: $${rev.toLocaleString()}/mo\nTotal Employees: ${emp}`;
                show('portfolio');
            }else{
                hide('portfolio');
            }
        }

        function switchCo(i){actIdx=i;updateSelector();updateDisplay();}
        
        function getCo(){
            const co=cos[actIdx];
            migrate(co);
            return co;
        }

        function migrate(co){
            if(co.exp!==undefined&&co.baseExp===undefined){
                const mode=isHard?'hard':'easy';
                const t=bizTypes[mode][co.type];
                if(t){
                    co.baseExp=t.baseExp||500;
                    co.expAdd=0;
                    delete co.exp;
                }
            }
            if(co.expAdd===undefined)co.expAdd=0;
            if(co.milestones===undefined)co.milestones=[];
            return co;
        }

        function calcRev(co){
            const s=getSpeed();
            const hardPen=isHard?0.8:1;
            const baseRev=co.rev;
            const revPerCust=(8+(co.qual/100)*10+(co.rep/100)*7);
            const custRev=co.cust*revPerCust;
            const empMult=co.emp>0?Math.min(2.0,1+(co.emp*0.1)):1;
            const qualMult=0.5+(co.qual/100);
            const repMult=0.5+(co.rep/100);
            const moraleMult=0.75+(co.morale/100)*0.35;
            let total=(baseRev+custRev)*empMult*qualMult*repMult*moraleMult;
            total+=co.revBoost;
            return Math.max(0,Math.floor(total*(0.95+Math.random()*0.1)*s*hardPen));
        }

        function calcExp(co){
            const s=getSpeed();
            const hardPen=isHard?1.2:1;
            if(co.baseExp===undefined)migrate(co);
            let e=co.baseExp+(co.emp*600)+(co.expAdd||0);
            co.loans.forEach(l=>e+=l.monthly);
            const moralePen=co.morale<40?1.12:1;
            return Math.max(0,Math.floor(e*moralePen*s*hardPen));
        }

        function calcDebt(co){
            const total=co.loans.reduce((s,l)=>s+l.monthly,0);
            return Math.floor((total/Math.max(calcRev(co),1))*100);
        }

        function checkMilestones(co){
            milestones.forEach(m=>{
                if(co.milestones.includes(m.name))return;
                let ok=false;
                if(m.cash&&co.cash>=m.cash)ok=true;
                if(m.cust&&co.cust>=m.cust)ok=true;
                if(m.emp&&co.emp>=m.emp)ok=true;
                if(m.rep&&co.rep>=m.rep)ok=true;
                if(ok){
                    co.milestones.push(m.name);
                    Object.keys(m.bonus).forEach(k=>{
                        if(k==='cash')co.cash+=m.bonus[k];
                        else co[k]=(co[k]||0)+m.bonus[k];
                    });
                    document.getElementById('milestoneContent').textContent=m.msg;
                    show('milestoneBox');
                    setTimeout(()=>hide('milestoneBox'),5000);
                }
            });
        }

        function updateDisplay(){
            const co=getCo();
            const stats=[
                ['CASH',`$${co.cash.toLocaleString()}`],
                ['MONTH',co.month],
                ['EMPLOYEES',co.emp],
                ['REPUTATION',`${Math.max(0,Math.min(100,co.rep))}/100`],
                ['CUSTOMERS',co.cust],
                ['QUALITY',`${Math.max(0,Math.min(100,co.qual))}/100`],
                ['REVENUE/MO',`$${calcRev(co).toLocaleString()}`],
                ['EXPENSES/MO',`$${calcExp(co).toLocaleString()}`],
                ['MORALE',`${Math.max(0,Math.min(100,co.morale))}/100`],
                ['DEBT',`${calcDebt(co)}%`]
            ];
            document.getElementById('stats').innerHTML=stats.map(([k,v])=>`<div class="stat-item">${k}: ${v}</div>`).join('');
            document.getElementById('debtPct').textContent=calcDebt(co);
            
            const debt=calcDebt(co);
            if(debt>60){
                document.getElementById('debtWarn').textContent=`WARNING: HIGH DEBT ${debt}%`;
                show('debtWarn');
            }else{
                hide('debtWarn');
            }
            
            checkMilestones(co);
        }

        function hideAll(){
            ['reportScreen','eventScreen','actionScreen','victoryScreen','gameOverScreen'].forEach(hide);
        }

        function showReport(){
            hideAll();
            const co=getCo();
            const rev=calcRev(co),exp=calcExp(co),net=rev-exp;
            
            co.cash+=net;
            co.total.rev+=rev;
            co.total.exp+=exp;
            co.loans=co.loans.filter(l=>{l.months--;if(l.months<=0)co.expAdd-=l.monthly;return l.months>0;});
            
            const s=getSpeed();
            const decay=isHard?1.5:1;
            co.qual=Math.max(0,co.qual-(2*s*decay));
            co.morale=Math.max(0,co.morale-(1.5*s*decay));
            const retention=isHard?0.96:0.98;
            co.cust=Math.max(0,Math.floor(co.cust*retention));
            co.revBoost=Math.floor(co.revBoost*0.7);
            
            if(co.qual>70)co.rep=Math.min(100,co.rep+1);
            if(co.eventHistory.length>10)co.eventHistory=co.eventHistory.slice(-10);
            
            document.getElementById('reportMonth').textContent=co.month;
            document.getElementById('reportContent').textContent=
                `${co.name}\n\nRevenue: +$${rev.toLocaleString()}\nExpenses: -$${exp.toLocaleString()}\n`+
                `(Base: $${co.baseExp} + Employees: $${co.emp*600} + Other: $${co.expAdd||0} + Loans: $${co.loans.reduce((s,l)=>s+l.monthly,0)})\n`+
                `Net Income: ${net>=0?'+':''}$${net.toLocaleString()}\n\nCash Balance: $${co.cash.toLocaleString()}\n`+
                (co.loans.length>0?`Active Loans: ${co.loans.length} (${calcDebt(co)}% debt)\n`:'')+
                `\nQuality -${(2*s*decay).toFixed(1)}\nMorale -${(1.5*s*decay).toFixed(1)}\nCustomer retention: ${(retention*100).toFixed(0)}%`;
            
            show('reportScreen');
            updateDisplay();
            updateSelector();
            
            if(co.cash>=150000&&co.rep>=75&&!co.victory){
                co.victory=true;
                showVictory();
            }else if(co.cash<-20000)showGameOver();
        }

        function meetsReq(evt,co){
            const req=evt.requires||{};
            return(!req.cust||co.cust>=req.cust)&&
                   (!req.emp||co.emp>=req.emp)&&
                   (!req.rep||co.rep>=req.rep)&&
                   (!req.qual||co.qual>=req.qual)&&
                   (!req.rev||co.rev>=req.rev)&&
                   (!req.cash||co.cash>=req.cash);
        }

        function showEvent(){
            hideAll();
            const co=getCo();
            
            let eligible=[];
            
            if(Math.random()<0.2){
                eligible=evts.universal.filter(e=>e.positive&&meetsReq(e,co)&&!co.eventHistory.includes(e.title));
            }
            
            if(eligible.length===0&&evts[co.type]){
                eligible=evts[co.type].filter(e=>meetsReq(e,co)&&!co.eventHistory.includes(e.title));
            }
            
            if(eligible.length===0){
                eligible=evts.universal.filter(e=>meetsReq(e,co)&&!co.eventHistory.includes(e.title));
            }
            
            if(eligible.length===0){
                if(evts[co.type])eligible=evts[co.type].filter(e=>meetsReq(e,co));
                if(eligible.length===0)eligible=evts.universal.filter(e=>meetsReq(e,co));
            }
            
            curEvt=eligible[Math.floor(Math.random()*eligible.length)];
            co.eventHistory.push(curEvt.title);
            
            const cont=document.getElementById('evtCont');
            const title=document.getElementById('evtTitle');
            if(curEvt.positive){
                cont.classList.add('pos');
                title.classList.add('pos');
            }else{
                cont.classList.remove('pos');
                title.classList.remove('pos');
            }
            
            title.textContent=curEvt.title;
            document.getElementById('evtDesc').textContent=curEvt.desc;
            renderChoices();
            show('eventScreen');
        }

        function renderChoices(){
            const co=getCo();
            const hasExpensive=curEvt.choices.some(c=>c.cost>co.cash);
            document.getElementById('evtLoans').classList.toggle('hidden',!hasExpensive);
            
            document.getElementById('choices').innerHTML=curEvt.choices.map(c=>{
                const dis=co.cash<c.cost;
                return `<button class="choice-btn" ${dis?'disabled':''} onclick='handleChoice(${JSON.stringify(c).replace(/'/g,"\\'")})'>${c.text}${dis&&c.cost>0?` [Need $${c.cost.toLocaleString()}]`:''}</button>`;
            }).join('')+`<button class="choice-btn ignore" onclick='handleIgnore(${JSON.stringify(curEvt.ignoreEffect).replace(/'/g,"\\'")})'>IGNORE SITUATION (Suffer consequences)</button>`;
        }

        function quickLoanEvt(amt,mo,mos){
            quickLoan(amt,mo,mos);
            renderChoices();
        }

        function handleIgnore(effects){
            hideAll();
            const co=getCo();
            let txt=`DECISION: Ignored the situation\n\nCONSEQUENCES:\n`;
            Object.keys(effects).forEach(k=>{
                if(effects[k]){
                    if(k==='expAdd'){
                        co.expAdd+=effects[k];
                        txt+=`Monthly Expenses: ${effects[k]>0?'+':''}$${Math.abs(effects[k])}/mo\n`;
                    }else{
                        co[k]=(co[k]||0)+effects[k];
                        txt+=`${k.charAt(0).toUpperCase()+k.slice(1)}: ${effects[k]>0?'+':''}${k==='cash'||k==='rev'?'$':''}${Math.abs(effects[k]).toLocaleString()}${k==='rev'?'/mo':''}\n`;
                    }
                }
            });
            if(Object.keys(effects).length===0)txt+='No immediate consequences.\n';
            txt+='\nTake additional actions before next month.';
            ['rep','qual','morale'].forEach(k=>co[k]=Math.max(0,Math.min(100,co[k])));
            co.cust=Math.max(0,co.cust);
            co.emp=Math.max(0,co.emp);
            document.getElementById('result').innerHTML='<pre>'+txt+'</pre>';
            actions=[];
            document.getElementById('logContent').textContent='No actions taken this month.';
            show('actionScreen');
            updateDisplay();
            updateSelector();
        }

        function handleChoice(choice){
            hideAll();
            const co=getCo();
            co.cash-=choice.cost;
            let txt=`DECISION: ${choice.text}\n\nEFFECTS:\n`;
            if(choice.cost!==0)txt+=`Cash: ${choice.cost>0?'-':'+'}$${Math.abs(choice.cost).toLocaleString()}\n`;
            const e=choice.effects;
            Object.keys(e).forEach(k=>{
                if(k==='loans'){
                    co.loans.push(e.loans);
                    co.expAdd+=e.loans.monthly;
                    txt+=`New Loan: -$${e.loans.monthly}/mo for ${e.loans.months} months\n`;
                }else if(k==='expAdd'&&e[k]){
                    co.expAdd+=e[k];
                    txt+=`Monthly Expenses: ${e[k]>0?'+':''}$${Math.abs(e[k])}/mo\n`;
                }else if(e[k]){
                    co[k]=(co[k]||0)+e[k];
                    txt+=`${k.charAt(0).toUpperCase()+k.slice(1)}: ${e[k]>0?'+':''}${k==='rev'?'$':''}${Math.abs(e[k])}${k==='rev'?'/mo':''}\n`;
                }
            });
            txt+='\nTake additional actions before next month.';
            ['rep','qual','morale'].forEach(k=>co[k]=Math.max(0,Math.min(100,co[k])));
            co.cust=Math.max(0,co.cust);
            co.emp=Math.max(0,co.emp);
            document.getElementById('result').innerHTML='<pre>'+txt+'</pre>';
            actions=[];
            document.getElementById('logContent').textContent='No actions taken this month.';
            show('actionScreen');
            updateDisplay();
            updateSelector();
        }

        function log(msg){
            actions.push(msg);
            document.getElementById('logContent').innerHTML=actions.join('<br>');
        }

        function showTab(tab){
            curTab=tab;
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
            event.target.classList.add('active');
            ['opsTab','growthTab','financeTab','marketingTab','empireTab'].forEach(id=>
                document.getElementById(id).classList.toggle('hidden',id!==tab+'Tab')
            );
        }

        function quickLoan(amt,mo,mos){
            const co=getCo(),debt=calcDebt(co);
            let max=amt>=75000?65:amt>=30000?50:amt>=10000?30:20;
            if(debt>=max)return log(`X Debt too high (${debt}%)`);
            if((amt>=30000&&co.rep<50)||(amt>=75000&&co.rep<70))return log(`X Reputation too low (need ${amt>=75000?70:50}+)`);
            co.cash+=amt;
            co.loans.push({monthly:mo,months:mos});
            co.expAdd+=mo;
            log(`+ Loan: +$${amt.toLocaleString()} (-$${mo}/mo x${mos})`);
            updateDisplay();
            updateSelector();
        }

        function openTransferModal(){
            if(cos.length<2)return log('X Need 2+ companies');
            const co=getCo();
            document.getElementById('fromCo').textContent=co.name;
            document.getElementById('availCash').textContent=co.cash.toLocaleString();
            document.getElementById('targetCo').innerHTML=cos
                .map((c,i)=>i!==actIdx?`<option value="${i}">${c.name} ($${c.cash.toLocaleString()})</option>`:'')
                .filter(Boolean).join('');
            show('transferModal');
        }

        function closeModal(id){hide(id);}

        function confirmTransfer(){
            const co=getCo();
            const amt=parseInt(document.getElementById('transferAmt').value);
            const targetIdx=parseInt(document.getElementById('targetCo').value);
            if(!amt||amt<=0)return alert('Enter valid amount');
            if(co.cash<amt)return alert('Insufficient funds');
            co.cash-=amt;
            cos[targetIdx].cash+=amt;
            log(`+ Transfer: $${amt.toLocaleString()} to ${cos[targetIdx].name}`);
            closeModal('transferModal');
            updateDisplay();
            updateSelector();
        }

        function openProductModal(){
            ['prodName','prodType','prodMktg','prodTarget','prodBudget'].forEach(id=>{
                const el=document.getElementById(id);
                if(el.tagName==='INPUT')el.value='';
                else el.selectedIndex=0;
            });
            updateProdCost();
            show('productModal');
        }

        function updateProdCost(){
            let cost=0;
            const budget=document.getElementById('prodBudget').value;
            const mktg=document.getElementById('prodMktg').value;
            if(budget==='low')cost+=5000;
            if(budget==='medium')cost+=10000;
            if(budget==='high')cost+=20000;
            if(mktg==='aggressive')cost+=5000;
            if(mktg==='moderate')cost+=2500;
            if(mktg==='minimal')cost+=500;
            document.getElementById('prodCost').textContent=cost.toLocaleString();
            const co=getCo();
            document.getElementById('prodLoans').classList.toggle('hidden',!(cost>0&&cost>co.cash));
            if(cost>0){
                const type=document.getElementById('prodType').value;
                const est={premium:'Est: High margins, fewer customers',standard:'Est: Balanced approach',budget:'Est: Low margins, high volume'};
                document.getElementById('prodEst').textContent=est[type]||'';
            }
        }

        function quickLoanModal(amt,mo,mos){
            quickLoan(amt,mo,mos);
            updateProdCost();
        }

        function confirmProduct(){
            const co=getCo();
            const name=document.getElementById('prodName').value.trim();
            const type=document.getElementById('prodType').value;
            const mktg=document.getElementById('prodMktg').value;
            const target=document.getElementById('prodTarget').value;
            const budget=document.getElementById('prodBudget').value;
            if(!name||!type||!mktg||!target||!budget)return alert('Fill all fields');
            let cost=0;
            const costs={low:5000,medium:10000,high:20000};
            const mktgCosts={aggressive:5000,moderate:2500,minimal:500};
            cost=(costs[budget]||0)+(mktgCosts[mktg]||0);
            if(co.cash<cost)return alert(`Need $${cost.toLocaleString()}`);
            co.cash-=cost;
            const budgetBonus={high:{qual:15,rev:800},medium:{qual:10,rev:500},low:{qual:5,rev:300}};
            const typeBonus={premium:{rev:600,cust:20},standard:{rev:400,cust:40},budget:{rev:200,cust:70}};
            const mktgBonus={aggressive:50,moderate:30,minimal:15};
            const qualGain=budgetBonus[budget].qual;
            const revGain=budgetBonus[budget].rev+typeBonus[type].rev;
            const custGain=typeBonus[type].cust+mktgBonus[mktg];
            co.rev+=revGain;
            co.cust+=custGain;
            co.qual+=qualGain;
            log(`+ Launched "${name}" (${type}) - +$${revGain}/mo, +${custGain} cust, +${qualGain} qual`);
            closeModal('productModal');
            updateDisplay();
            updateSelector();
        }

        const actMap={
            hire:()=>{
                const co=getCo();
                if(co.cash<2500)return log('X Need $2,500');
                co.cash-=2500;co.emp++;co.qual+=3;co.expAdd+=600;
                log('+ Hired (+1, Qual +3, +$600/mo)');
            },
            fire:()=>{
                const co=getCo();
                if(co.emp<=0)return log('X No employees');
                co.emp--;co.cash+=800;co.rep-=8;co.morale-=15;co.qual-=5;co.expAdd-=600;
                log('+ Fired (+$800, -$600/mo, Rep -8)');
            },
            train:()=>{
                const co=getCo();
                if(co.emp===0)return log('X No employees');
                if(co.cash<1500)return log('X Need $1,500');
                co.cash-=1500;co.qual+=10;co.morale+=12;
                log('+ Training (Qual +10, Morale +12)');
            },
            wages:()=>{
                const co=getCo();
                if(co.emp===0)return log('X No employees');
                const cost=co.emp*300;
                if(co.cash<cost)return log(`X Need $${cost.toLocaleString()}`);
                co.cash-=cost;co.expAdd+=co.emp*30;co.morale+=20;co.rep+=5;
                log(`+ Wages raised (Morale +20, +$${co.emp*30}/mo exp)`);
            },
            workplace:()=>{
                const co=getCo();
                if(co.cash<3000)return log('X Need $3,000');
                co.cash-=3000;co.morale+=18;co.rep+=8;
                log('+ Workplace improved (Morale +18)');
            },
            automate:()=>{
                const co=getCo();
                if(co.cash<5000)return log('X Need $5,000');
                co.cash-=5000;co.qual+=12;co.expAdd+=200;
                log('+ Automated (Qual +12, +$200/mo maintenance)');
            },
            quality:()=>{
                const co=getCo();
                if(co.cash<2000)return log('X Need $2,000');
                co.cash-=2000;co.qual+=15;co.revBoost+=400;
                log('+ QC (Qual +15, +$400/mo temp)');
            },
            cs:()=>{
                const co=getCo();
                if(co.cash<1800)return log('X Need $1,800');
                co.cash-=1800;
                const gain=Math.floor(25/(1+co.cust*0.004));
                co.cust+=gain;co.rep+=10;
                log(`+ CS (+${gain} cust, Rep +10)`);
            },
            maintain:()=>{
                const co=getCo();
                if(co.cash<1000)return log('X Need $1,000');
                co.cash-=1000;co.qual+=6;
                log('+ Maintenance (Qual +6)');
            },
            expand:()=>{
                const co=getCo();
                if(co.cash<15000)return log('X Need $15,000');
                co.cash-=15000;co.rev+=1200;co.cust+=80;co.emp+=2;co.expAdd+=1200;
                log('+ New location (+80 cust, +$1200/mo, +2 emp, +$1200/mo exp)');
            },
            product:()=>openProductModal(),
            partner:()=>{
                const co=getCo();
                if(co.cash<4000)return log('X Need $4,000');
                co.cash-=4000;co.cust+=50;co.rep+=12;co.revBoost+=800;
                log('+ Partnership (+50 cust, +$800/mo temp)');
            },
            franchise:()=>{
                const co=getCo();
                if(co.cash<12000)return log('X Need $12,000');
                co.cash-=12000;co.rev+=1500;co.cust+=60;co.rep+=15;
                log('+ Franchise (+60 cust, +$1500/mo)');
            },
            acquire:()=>{
                const co=getCo();
                if(co.cash<25000)return log('X Need $25,000');
                co.cash-=25000;co.cust+=75;co.emp+=3;co.rev+=1800;co.expAdd+=1800;
                log('+ Acquisition (+75 cust, +$1800/mo, +3 emp, +$1800/mo exp)');
            },
            intl:()=>{
                const co=getCo();
                if(co.cash<35000)return log('X Need $35,000');
                co.cash-=35000;co.cust+=120;co.rev+=3000;co.emp+=5;co.rep+=20;co.expAdd+=3000;
                log('+ International (+120 cust, +$3000/mo, +5 emp, +$3000/mo exp)');
            },
            investor:()=>{
                const co=getCo();
                if(co.rep<40)return log('X Rep too low');
                co.cash+=20000;co.expAdd+=Math.floor(co.rev*0.08);
                log('+ Investor (+$20K, 8% rev share)');
            },
            cut:()=>{
                const co=getCo();
                if(co.emp<=1)return log('X Not enough employees');
                co.emp-=2;co.cash+=1500;co.rep-=15;co.morale-=25;co.qual-=10;co.expAdd-=1200;
                log('+ Emergency cuts (-2 emp, +$1500, -$1200/mo exp)');
            },
            stocks:()=>{
                const co=getCo();
                if(co.cash<5000)return log('X Need $5,000');
                co.cash-=5000;
                const gain=Math.random()>0.5?Math.floor(Math.random()*3000+1000):-Math.floor(Math.random()*2000);
                co.cash+=gain;
                log(`+ Stocks ${gain>0?'gained':'lost'} $${Math.abs(gain).toLocaleString()}`);
            },
            realestate:()=>{
                const co=getCo();
                if(co.cash<18000)return log('X Need $18,000');
                co.cash-=18000;co.rev+=1000;
                log('+ Real estate (+$1000/mo passive)');
            },
            refinance:()=>{
                const co=getCo();
                if(co.loans.length===0)return log('X No loans');
                if(co.cash<3000)return log('X Need $3,000');
                co.cash-=3000;
                co.loans.forEach(l=>{const r=Math.floor(l.monthly*0.25);co.expAdd-=r;l.monthly-=r;});
                log('+ Refinanced (25% reduction)');
            },
            payoff:()=>{
                const co=getCo();
                if(co.loans.length===0)return log('X No loans');
                const loan=co.loans[0];
                const owed=loan.monthly*loan.months;
                if(co.cash<owed)return log(`X Need $${owed.toLocaleString()}`);
                co.cash-=owed;co.expAdd-=loan.monthly;co.loans.shift();
                log(`+ Paid off (-$${owed.toLocaleString()}, -$${loan.monthly}/mo)`);
            },
            marketing:()=>{
                const co=getCo();
                if(co.cash<3500)return log('X Need $3,500');
                co.cash-=3500;
                const gain=Math.floor(40/(1+co.cust*0.002));
                co.revBoost+=2000;co.cust+=gain;co.rep+=10;
                log(`+ Campaign (+${gain} cust, +$2000/mo temp)`);
            },
            social:()=>{
                const co=getCo();
                if(co.cash<1200)return log('X Need $1,200');
                co.cash-=1200;co.cust+=20;
                log('+ Social media (+20 cust)');
            },
            pr:()=>{
                const co=getCo();
                if(co.cash<2500)return log('X Need $2,500');
                co.cash-=2500;co.rep+=18;co.cust+=25;
                log('+ PR (Rep +18, +25 cust)');
            },
            rebrand:()=>{
                const co=getCo();
                if(co.cash<5000)return log('X Need $5,000');
                co.cash-=5000;co.rep+=15;co.cust+=40;
                log('+ Rebrand (Rep +15, +40 cust)');
            },
            influencer:()=>{
                const co=getCo();
                if(co.cash<4000)return log('X Need $4,000');
                co.cash-=4000;co.cust+=55;co.rep+=15;
                log('+ Influencer (+55 cust, Rep +15)');
            },
            seo:()=>{
                const co=getCo();
                if(co.cash<3000)return log('X Need $3,000');
                co.cash-=3000;co.cust+=35;co.rev+=600;
                log('+ SEO (+35 cust, +$600/mo)');
            },
            newco:()=>{
                const total=cos.reduce((s,c)=>s+c.cash,0);
                if(total<20000)return log('X Need $20K total');
                const name=prompt('Company name:');
                if(!name||!name.trim())return;
                const types=Object.keys(bizTypes[isHard?'hard':'easy']);
                const choice=prompt('Type:\n'+types.map((t,i)=>`${i+1}. ${bizTypes[isHard?'hard':'easy'][t].name}`).join('\n'));
                const type=types[parseInt(choice)-1];
                if(!type)return alert('Invalid');
                getCo().cash-=20000;
                cos.push(createCo(type,name.trim(),false));
                actIdx=cos.length-1;
                updateSelector();
                updateDisplay();
                log(`+ Started ${name.trim()}`);
            },
            transfer:()=>openTransferModal(),
            cross:()=>{
                const co=getCo();
                if(cos.length<2)return log('X Need 2+ companies');
                if(co.cash<2000)return log('X Need $2,000');
                co.cash-=2000;
                cos.forEach(c=>{c.cust+=12;c.rep+=4;});
                log('+ Cross-promo (+12 cust all)');
                updateSelector();
            },
            merge:()=>{
                if(cos.length<2)return log('X Need 2+ companies');
                const idx=parseInt(prompt('Merge with:\n'+cos.map((c,i)=>
                    i!==actIdx?`${i+1}. ${c.name}`:''
                ).filter(Boolean).join('\n')))-1;
                if(idx<0||idx>=cos.length||idx===actIdx)return;
                const co=getCo();
                const target=cos[idx];
                co.cash+=target.cash;co.emp+=target.emp;co.cust+=target.cust;
                co.rev+=target.rev;co.expAdd+=target.expAdd;
                co.qual=Math.floor((co.qual+target.qual)/2);
                cos.splice(idx,1);
                if(idx<actIdx)actIdx--;
                log(`+ Merged ${target.name}`);
                updateSelector();
            },
            sell:()=>{
                if(cos.length<=1)return log('X Cannot sell only company');
                const co=getCo();
                const val=co.cash+(calcRev(co)-calcExp(co))*15;
                if(confirm(`Sell ${co.name} for $${val.toLocaleString()}?`)){
                    cos.splice(actIdx,1);
                    actIdx=Math.max(0,actIdx-1);
                    cos[actIdx].cash+=val;
                    updateSelector();
                    updateDisplay();
                    log(`+ Sold for $${val.toLocaleString()}`);
                }
            }
        };

        function act(type){
            if(actMap[type]){
                actMap[type]();
                updateDisplay();
                updateSelector();
            }
        }

        function nextMonth(){
            hideAll();
            getCo().month++;
            showReport();
        }

        function showVictory(){
            hideAll();
            const co=getCo();
            document.getElementById('victoryContent').textContent=
                `${co.name} reached $150K+ with 75+ rep!\n\nMode: ${isHard?'HARD':'Easy'}\nTime: ${co.month} months\nCash: $${co.cash.toLocaleString()}\nEmployees: ${co.emp}\nCustomers: ${co.cust}\nRep: ${co.rep}/100\n\nContinue building your empire!`;
            show('victoryScreen');
        }

        function continueVictory(){hideAll();showReport();}

        function showGameOver(){
            hideAll();
            const co=getCo();
            document.getElementById('gameOverContent').textContent=
                `${co.name} declared bankruptcy.\n\nMode: ${isHard?'HARD':'Easy'}\nSurvived: ${co.month} months\nCash: $${co.cash.toLocaleString()}\n`+
                (cos.length>1?`\nYou have ${cos.length-1} other company/companies.`:'');
            show('gameOverScreen');
        }

        function closeCo(){
            if(cos.length>1){
                cos.splice(actIdx,1);
                actIdx=Math.max(0,actIdx-1);
                updateSelector();
                hideAll();
                showReport();
            }else{
                resetGame();
            }
        }

        function resetGame(){
            hide('gameScreen');
            hide('setupScreen');
            show('diffScreen');
            cos=[];
            actIdx=0;
            nextId=1;
            selBiz=null;
            selDiff=null;
            isHard=false;
        }

        function hide(id){document.getElementById(id).classList.add('hidden');}
        function show(id){document.getElementById(id).classList.remove('hidden');}
    </script>
</body>
</html>
